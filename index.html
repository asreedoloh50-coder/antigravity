<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ระบบตรวจงานพร้อมให้คะแนนออนไลน์ สำหรับครู นักเรียน และผู้ปกครอง">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ตรวจงาน">

    <title>ระบบตรวจงานพร้อมให้คะแนนออนไลน์</title>

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Global Error Handler for debugging on mobile/deployment
        window.onerror = function (msg, url, line, col, error) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.background = 'white';
                errorDiv.style.padding = '20px';
                errorDiv.style.margin = '20px';
                errorDiv.style.borderRadius = '8px';
                errorDiv.style.zIndex = '9999';
                errorDiv.innerHTML = `<h3>Error Detected:</h3><p>${msg}</p><p>${url}:${line}:${col}</p>`;
                overlay.appendChild(errorDiv);
                // Also hide the spinner so the error is visible
                overlay.querySelector('.animate-spin')?.classList.add('hidden');
            }
            return false;
        };
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'thai': ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="font-thai bg-gray-50 text-gray-900 min-h-screen">
    <!-- iOS Install Banner -->
    <div id="ios-install-banner"
        class="hidden fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 shadow-lg">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center space-x-3">
                <img src="assets/icons/icon-192.png" alt="App Icon" class="w-12 h-12 rounded-xl">
                <div>
                    <p class="font-semibold">ติดตั้งแอปตรวจงาน</p>
                    <p class="text-sm opacity-90">Safari → แชร์ → เพิ่มในหน้าจอโฮม</p>
                </div>
            </div>
            <button onclick="hideIOSBanner()" class="p-2 hover:bg-white/20 rounded-full transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- PWA Install Prompt (Floating Card) -->
    <div id="install-prompt" class="hidden fixed bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-[400px] z-50">
        <div
            class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-5 transform transition-all duration-300 hover:scale-[1.02]">
            <div class="flex items-start space-x-4">
                <div class="bg-primary-50 p-2 rounded-xl shrink-0">
                    <img src="assets/icons/icon-192.png" alt="App Icon"
                        class="w-12 h-12 rounded-lg object-cover shadow-sm">
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-gray-900 text-lg leading-tight">ติดตั้งแอป</h3>
                    <p class="text-sm text-gray-500 mt-1">ใช้งานสะดวกขึ้น เหมือนแอปจริงบนมือถือของคุณ</p>
                </div>
                <button onclick="hideInstallPrompt()" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex gap-3 mt-5">
                <button onclick="hideInstallPrompt()"
                    class="flex-1 py-2.5 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition text-sm">
                    ไม่ใช่ตอนนี้
                </button>
                <button onclick="installPWA()"
                    class="flex-1 py-2.5 px-4 rounded-xl bg-primary-600 text-white font-bold hover:bg-primary-700 transition shadow-lg shadow-primary-600/30 text-sm">
                    ติดตั้งทันที
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="relative">
                <div
                    class="w-16 h-16 border-4 border-primary-200 rounded-full animate-spin border-t-primary-600 mx-auto">
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-8 h-8 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838l-2.727 1.17 1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0z" />
                    </svg>
                </div>
            </div>
            <p class="mt-4 text-gray-600 font-medium">กำลังโหลด...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[90] space-y-2"></div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Content will be rendered here by router -->
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav id="bottom-nav"
        class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 md:hidden z-40 safe-area-bottom">
        <div class="flex justify-around items-center h-16" id="bottom-nav-items">
            <!-- Nav items will be rendered based on role -->
        </div>
    </nav>

    <!-- Scripts -->
    <script>
        const failedScripts = new Set();
        function handleScriptError(e) {
            console.error('Script failed to load:', e.target.src);
            failedScripts.add(e.target.src.split('/').pop());

            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                const fileList = Array.from(failedScripts).map(f => `<li class="text-xs font-mono text-red-600 bg-red-50 p-1 rounded inline-block m-0.5">${f}</li>`).join('');

                overlay.innerHTML = `<div class="p-6 text-center max-w-sm mx-auto">
                    <div class="mb-4 text-red-500">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">ไม่สามารถโหลดไฟล์ระบบได้ (${failedScripts.size})</h3>
                    <p class="text-sm text-gray-600 mb-2">ระบบหาไฟล์เหล่านี้ไม่เจอ:</p>
                    <ul class="mb-6 text-left border border-red-100 rounded-lg p-2 max-h-32 overflow-y-auto">${fileList}</ul>
                    <button onclick="location.reload()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition">รีโหลดหน้าเว็บ</button>
                    <p class="text-xs text-gray-400 mt-4">ตรวจสอบว่าโฟลเดอร์ js/ ถูกอัปโหลดไปที่ Server หรือไม่</p>
                </div>`;
            }
        }
    </script>
    <script src="js/i18n.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/utils.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/store.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/api.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/auth.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/router.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/teacher.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/student.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/parent.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/admin.js?v=4" onerror="handleScriptError(event)"></script>
    <script src="js/app.js?v=4" onerror="handleScriptError(event)"></script>

    <!-- PWA Install Script -->
    <script>
        // Safety Timeout
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                // Check if App is running
                if (typeof App === 'undefined') {
                    overlay.innerHTML = `<div class="p-4 text-center">
                        <div class="mb-4 text-orange-500">
                             <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">ระบบโหลดช้าผิดปกติ</h3>
                        <p class="text-gray-600 mb-4">ระบบใช้เวลานานเกินไปในการเริ่มต้น อาจมีปัญหาทางเทคนิค</p>
                        <div class="space-x-2">
                             <button onclick="location.reload()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">ลองใหม่อีกครั้ง</button>
                             <button onclick="document.getElementById('loading-overlay').classList.add('hidden')" class="px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">เข้าใช้งานต่อ</button>
                        </div>
                    </div>`;
                }
            }
        }, 10000);

        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('install-prompt').classList.remove('hidden');
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            } else {
                // Should not happen usually as we hide button, but just in case
                if (isIOS()) {
                    alert('สำหรับ iOS: กดปุ่ม "แชร์" ด้านล่าง แล้วเลือก "เพิ่มไปยังหน้าจอโฮม"');
                } else {
                    alert('ไม่สามารถติดตั้งอัตโนมัติได้ กรุณาใช้เมนูของเบราว์เซอร์เพื่อติดตั้ง');
                }
            }
        }

        function hideInstallPrompt() {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // iOS Detection
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }

        function showIOSBanner() {
            if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ios-banner-dismissed')) {
                document.getElementById('ios-install-banner').classList.remove('hidden');
            }
        }

        function hideIOSBanner() {
            document.getElementById('ios-install-banner').classList.add('hidden');
            localStorage.setItem('ios-banner-dismissed', 'true');
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Show iOS banner after delay
        setTimeout(showIOSBanner, 2000);

        // DEMO ONLY: Force show Install Prompt if not shown (for visual check)
        // Only run if NOT iOS and NO default prompt captured yet
        setTimeout(() => {
            if (isIOS()) return; // Skip on iOS

            const prompt = document.getElementById('install-prompt');
            const isHidden = prompt.classList.contains('hidden');
            // Only show if we haven't already captured an event (which handles showing it)
            // and strictly for demo purposes if browser didn't fire it? 
            // Better to rely on the event, but user might want to see the UI.
            // We'll check if deferredPrompt is missing.
            if (isHidden && !window.matchMedia('(display-mode: standalone)').matches && !deferredPrompt) {
                // Actually, if !deferredPrompt, the button won't work. 
                // So we should probably NOT show it here unless we are debugging UI.
                // Commenting out the force show to prevent broken UI
                // console.log('Demo: Force show suppressed because no install prompt available');
            }
        }, 2500);
    </script>
</body>

</html>